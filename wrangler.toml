name = "simplechat"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat_v2"]
main = "./custom-worker.ts"
minify = true
assets = { directory = ".open-next/assets", binding = "ASSETS" }

# Durable Objects for long-running tasks (SQLite storage for Free plan)
[[durable_objects.bindings]]
name = "TASK_PROCESSOR"
class_name = "TaskProcessor"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["TaskProcessor"]

# Bindings for local development
[[d1_databases]]
binding = "DB"
database_name = "simplechat-db"
database_id = "eace923b-b0d6-4a99-a82e-6a4d144e4ca5"

[[r2_buckets]]
binding = "BUCKET"
bucket_name = "simplechat-assets"

# R2 bucket for Next.js incremental cache (ISR)
[[r2_buckets]]
binding = "NEXT_INC_CACHE_R2_BUCKET"
bucket_name = "simplechat-cache"

# Vectorize Index for Embeddings
[[vectorize]]
binding = "VECTORIZE_INDEX"
index_name = "simplechat-index"
remote=true

# Cloudflare AI Binding
[ai]
binding = "AI"

# Cloudflare Queue for async PDF processing
[[queues.producers]]
queue = "pdf-processing-queue"
binding = "PDF_QUEUE"

[[queues.consumers]]
queue = "pdf-processing-queue"
max_batch_size = 1
max_batch_timeout = 30

[observability]
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = true

[observability.traces]
enabled = false
persist = true
head_sampling_rate = 1

[[routes]]
pattern = "rynk.io"
custom_domain = true

[vars]
AUTH_TRUST_HOST = "true"
AUTH_URL = "https://rynk.io"
NEXTAUTH_URL = "https://rynk.io"

[triggers]
crons = ["0 0 * * *"]

[limits]
cpu_ms = 100_000